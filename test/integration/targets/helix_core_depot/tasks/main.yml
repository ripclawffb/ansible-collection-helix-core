# Test code for the Helix depot module
# -*- coding: utf-8 -*-

# Copyright: (c) 2019, Asif Shaikh (@ripclawffb) <ripclaw_ffb@hotmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# - name: Install required lib
#   pip:
#     name: p4python
#     executable: pip3

- name: Create a new depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: bruno
    type: local
    description: Bruno's depot
    map: depot/...
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_depot

- name: Output create_depot
  ansible.builtin.debug:
    var: create_depot

- name: Verify create_depot is changed
  ansible.builtin.assert:
    that:
      - create_depot is changed

- name: Create a specs depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_spec_depot

- name: Output create_spec_depot
  ansible.builtin.debug:
    var: create_spec_depot

- name: Verify create_spec_depot is changed
  ansible.builtin.assert:
    that:
      - create_spec_depot is changed

# Tests for suffix field (bug fix verification)
# Note: Perforce only allows one spec depot, so we update the existing 'spec' depot
- name: Update spec depot with custom suffix
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    suffix: .txt
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_spec_depot_suffix

- name: Output update_spec_depot_suffix
  ansible.builtin.debug:
    var: update_spec_depot_suffix

- name: Verify update_spec_depot_suffix is changed
  ansible.builtin.assert:
    that:
      - update_spec_depot_suffix is changed

- name: Update spec depot with custom suffix (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    suffix: .txt
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_spec_depot_suffix_idempotent

- name: Output update_spec_depot_suffix_idempotent
  ansible.builtin.debug:
    var: update_spec_depot_suffix_idempotent

- name: Verify update_spec_depot_suffix_idempotent is not changed
  ansible.builtin.assert:
    that:
      - update_spec_depot_suffix_idempotent is not changed

- name: Update spec depot suffix to different value
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    suffix: .json
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_spec_depot_suffix_change

- name: Output update_spec_depot_suffix_change
  ansible.builtin.debug:
    var: update_spec_depot_suffix_change

- name: Verify update_spec_depot_suffix_change is changed
  ansible.builtin.assert:
    that:
      - update_spec_depot_suffix_change is changed

- name: Update spec depot suffix to different value (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    suffix: .json
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_spec_depot_suffix_change_idempotent

- name: Output update_spec_depot_suffix_change_idempotent
  ansible.builtin.debug:
    var: update_spec_depot_suffix_change_idempotent

- name: Verify update_spec_depot_suffix_change_idempotent is not changed
  ansible.builtin.assert:
    that:
      - update_spec_depot_suffix_change_idempotent is not changed

# Reset spec depot to default suffix for other tests
- name: Reset spec depot to default suffix
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto

- name: Create a tangent depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: tangent
    type: tangent
    description: Tangent depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_tangent_depot

- name: Output create_tangent_depot
  ansible.builtin.debug:
    var: create_tangent_depot

- name: Verify create_tangent_depot is changed
  ansible.builtin.assert:
    that:
      - create_tangent_depot is changed

- name: Create a unload depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: unload
    type: unload
    description: Unload depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_unload_depot

- name: Output create_unload_depot
  ansible.builtin.debug:
    var: create_unload_depot

- name: Verify create_unload_depot is changed
  ansible.builtin.assert:
    that:
      - create_unload_depot is changed

- name: Create a archive depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: archive
    type: archive
    description: Archive depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_archive_depot

- name: Output create_archive_depot
  ansible.builtin.debug:
    var: create_archive_depot

- name: Verify create_archive_depot is changed
  ansible.builtin.assert:
    that:
      - create_archive_depot is changed

- name: Create a remote depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: remote
    address: '1666'
    type: remote
    description: Remote depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_remote_depot

- name: Output create_remote_depot
  ansible.builtin.debug:
    var: create_remote_depot

- name: Verify create_remote_depot is changed
  ansible.builtin.assert:
    that:
      - create_remote_depot is changed

- name: Create a stream depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: stream_depot
    streamdepth: '//stream_depot/1/2/3'
    type: stream
    description: Stream depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_stream_depot

- name: Output create_stream_depot
  ansible.builtin.debug:
    var: create_stream_depot

- name: Verify create_stream_depot is changed
  ansible.builtin.assert:
    that:
      - create_stream_depot is changed

- name: Create a new depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: bruno
    type: local
    description: Bruno's depot
    map: depot/...
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_depot_idempotent

- name: Output create_depot_idempotent
  ansible.builtin.debug:
    var: create_depot_idempotent

- name: Verify create_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_depot_idempotent is not changed

- name: Create a specs depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: spec
    type: spec
    description: Specs depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_spec_depot_idempotent

- name: Output create_spec_depot_idempotent
  ansible.builtin.debug:
    var: create_spec_depot_idempotent

- name: Verify create_spec_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_spec_depot_idempotent is not changed

- name: Create a tangent depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: tangent
    type: tangent
    description: Tangent depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_tangent_depot_idempotent

- name: Output create_tangent_depot_idempotent
  ansible.builtin.debug:
    var: create_tangent_depot_idempotent

- name: Verify create_tangent_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_tangent_depot_idempotent is not changed

- name: Create a unload depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: unload
    type: unload
    description: Unload depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_unload_depot_idempotent

- name: Output create_unload_depot_idempotent
  ansible.builtin.debug:
    var: create_unload_depot_idempotent

- name: Verify create_unload_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_unload_depot_idempotent is not changed

- name: Create a archive depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: archive
    type: archive
    description: Archive depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_archive_depot_idempotent

- name: Output create_archive_depot_idempotent
  ansible.builtin.debug:
    var: create_archive_depot_idempotent

- name: Verify create_archive_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_archive_depot_idempotent is not changed

- name: Create a remote depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: remote
    address: '1666'
    type: remote
    description: Remote depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_remote_depot_idempotent

- name: Output create_remote_depot_idempotent
  ansible.builtin.debug:
    var: create_remote_depot_idempotent

- name: Verify create_remote_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_remote_depot_idempotent is not changed

- name: Create a stream depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: stream_depot
    streamdepth: '//stream_depot/1/2/3'
    type: stream
    description: Stream depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: create_stream_depot_idempotent

- name: Output create_stream_depot_idempotent
  ansible.builtin.debug:
    var: create_stream_depot_idempotent

- name: Verify create_stream_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_stream_depot_idempotent is not changed

- name: Update depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: bruno
    type: local
    description: Bruno's updated depot
    map: depot/...
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_depot

- name: Output update_depot
  ansible.builtin.debug:
    var: update_depot

- name: Verify update_depot is changed
  ansible.builtin.assert:
    that:
      - update_depot is changed

- name: Update depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: bruno
    type: local
    description: Bruno's updated depot
    map: depot/...
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: update_depot_idempotent

- name: Output update_depot_idempotent
  ansible.builtin.debug:
    var: update_depot_idempotent

- name: Verify update_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - update_depot_idempotent is not changed

- name: Delete depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: absent
    depot: bruno
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: delete_depot

- name: Output delete_depot
  ansible.builtin.debug:
    var: delete_depot

- name: Verify delete_depot is changed
  ansible.builtin.assert:
    that:
      - delete_depot is changed

- name: Delete a depot (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: absent
    depot: bruno
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: delete_depot_idempotent

- name: Output delete_depot_idempotent
  ansible.builtin.debug:
    var: delete_depot_idempotent

- name: Verify delete_depot_idempotent is not changed
  ansible.builtin.assert:
    that:
      - delete_depot_idempotent is not changed

# Diff mode tests
- name: Create depot with diff mode
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Diff test depot
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: diff_create_depot
  diff: true

- name: Output diff_create_depot
  ansible.builtin.debug:
    var: diff_create_depot

- name: Verify diff output on depot create
  ansible.builtin.assert:
    that:
      - diff_create_depot is changed
      - diff_create_depot.diff is defined
      - diff_create_depot.diff.before is defined
      - diff_create_depot.diff.after is defined
      - diff_create_depot.diff.before == ''
      - "'Diff test depot' in diff_create_depot.diff.after"

- name: Create depot with diff mode (idempotent)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Diff test depot
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: diff_create_depot_idempotent
  diff: true

- name: Verify no diff on idempotent depot run
  ansible.builtin.assert:
    that:
      - diff_create_depot_idempotent is not changed
      - diff_create_depot_idempotent.diff is not defined

- name: Update depot with diff mode
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Diff test depot updated
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: diff_update_depot
  diff: true

- name: Output diff_update_depot
  ansible.builtin.debug:
    var: diff_update_depot

- name: Verify diff output on depot update
  ansible.builtin.assert:
    that:
      - diff_update_depot is changed
      - diff_update_depot.diff is defined
      - "'Diff test depot' in diff_update_depot.diff.before"
      - "'Diff test depot updated' in diff_update_depot.diff.after"

- name: Update depot without diff mode (negative test)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Diff test depot final
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: diff_disabled_depot

- name: Verify no diff key when diff mode is not enabled
  ansible.builtin.assert:
    that:
      - diff_disabled_depot is changed
      - diff_disabled_depot.diff is not defined

- name: Update depot in check+diff mode
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Check mode update
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: check_diff_depot
  check_mode: true
  diff: true

- name: Output check_diff_depot
  ansible.builtin.debug:
    var: check_diff_depot

- name: Verify check+diff produces diff without changing
  ansible.builtin.assert:
    that:
      - check_diff_depot is changed
      - check_diff_depot.diff is defined
      - "'Diff test depot final' in check_diff_depot.diff.before"
      - "'Check mode update' in check_diff_depot.diff.after"

- name: Verify check mode did not actually change the depot
  ripclawffb.helix_core.helix_core_depot:
    state: present
    depot: diff_test_depot
    type: local
    description: Diff test depot final
    map: depot/...
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: verify_no_change_depot

- name: Confirm depot was not changed by check mode
  ansible.builtin.assert:
    that:
      - verify_no_change_depot is not changed

- name: Delete depot with diff mode
  ripclawffb.helix_core.helix_core_depot:
    state: absent
    depot: diff_test_depot
    server: '1666'
    user: 'bruno'
    password: ''
    charset: auto
  register: diff_delete_depot
  diff: true

- name: Output diff_delete_depot
  ansible.builtin.debug:
    var: diff_delete_depot

- name: Verify diff output on depot delete
  ansible.builtin.assert:
    that:
      - diff_delete_depot is changed
      - diff_delete_depot.diff is defined
      - "'Diff test depot final' in diff_delete_depot.diff.before"
      - diff_delete_depot.diff.after == ''

- name: Create new depot (check mode)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    name: bruno_new_depot
    description: 'New depot for Bruno'
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_depot_check_mode
  check_mode: true

- name: Output create_depot_check_mode
  ansible.builtin.debug:
    var: create_depot_check_mode

- name: Verify create_depot_check_mode is changed
  ansible.builtin.assert:
    that:
      - create_depot_check_mode is changed

- name: Create new depot (confirm check mode)
  ripclawffb.helix_core.helix_core_depot:
    state: present
    name: bruno_new_depot
    description: 'New depot for Bruno'
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_depot_check_mode_confirm

- name: Output create_depot_check_mode_confirm
  ansible.builtin.debug:
    var: create_depot_check_mode_confirm

- name: Verify create_depot_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - create_depot_check_mode_confirm is changed

- name: Delete depot (check mode)
  ripclawffb.helix_core.helix_core_depot:
    state: absent
    depot: bruno_new_depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: delete_depot_check_mode
  check_mode: true

- name: Output delete_depot_check_mode
  ansible.builtin.debug:
    var: delete_depot_check_mode

- name: Verify delete_depot_check_mode is changed
  ansible.builtin.assert:
    that:
      - delete_depot_check_mode is changed

- name: Delete depot (confirm check mode)
  ripclawffb.helix_core.helix_core_depot:
    state: absent
    depot: bruno_new_depot
    p4port: '1666'
    p4user: 'bruno'
    p4passwd: ''
    p4charset: auto
  register: delete_depot_check_mode_confirm

- name: Output delete_depot_check_mode_confirm
  ansible.builtin.debug:
    var: delete_depot_check_mode_confirm

- name: Verify delete_depot_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - delete_depot_check_mode_confirm is changed
