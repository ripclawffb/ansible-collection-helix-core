# Test code for the Helix group module
# -*- coding: utf-8 -*-

# Copyright: (c) 2019, Asif Shaikh (@ripclawffb) <ripclaw_ffb@hotmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# - name: Install required lib
#   pip:
#     name: p4python
#     executable: pip3

- name: Create new group
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: super_admins
    users:
       - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group

- name: Output create_group
  ansible.builtin.debug:
    var: create_group

- name: Verify create_group is changed
  ansible.builtin.assert:
    that:
      - create_group is changed

- name: Create new group (idempotent)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: super_admins
    users:
        - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group_idempotent

- name: Output create_group_idempotent
  ansible.builtin.debug:
    var: create_group_idempotent

- name: Verify create_group_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_group_idempotent is not changed

- name: Delete a group
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: super_admins
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_group

- name: Output delete_group
  ansible.builtin.debug:
    var: delete_group

- name: Verify delete_group is changed
  ansible.builtin.assert:
    that:
      - delete_group is changed

- name: Delete a group (idempotent)
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: super_admins
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_group_idempotent

- name: Output delete_group_idempotent
  ansible.builtin.debug:
    var: delete_group_idempotent

- name: Verify delete_group_idempotent is not changed
  ansible.builtin.assert:
    that:
      - delete_group_idempotent is not changed

- name: Create new group (check mode)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: new_group
    users:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group_check_mode
  check_mode: true

- name: Output create_group_check_mode
  ansible.builtin.debug:
    var: create_group_check_mode

- name: Verify create_group_check_mode is changed
  ansible.builtin.assert:
    that:
      - create_group_check_mode is changed

- name: Create new group (confirm check mode)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: new_group
    users:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group_check_mode_confirm

- name: Output create_group_check_mode_confirm
  ansible.builtin.debug:
    var: create_group_check_mode_confirm

- name: Verify create_group_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - create_group_check_mode_confirm is changed

- name: Delete group (check mode)
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: new_group
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_group_check_mode
  check_mode: true

- name: Output delete_group_check_mode
  ansible.builtin.debug:
    var: delete_group_check_mode

- name: Verify delete_group_check_mode is changed
  ansible.builtin.assert:
    that:
      - delete_group_check_mode is changed

- name: Delete group (confirm check mode)
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: new_group
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_group_check_mode_confirm

- name: Output delete_group_check_mode_confirm
  ansible.builtin.debug:
    var: delete_group_check_mode_confirm

- name: Verify delete_group_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - delete_group_check_mode_confirm is changed

- name: Create group with subgroups and owners
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: group_with_subgroups
    users:
      - bruno
    subgroups:
      - super_admins
    owners:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group_subgroups

- name: Output create_group_subgroups
  ansible.builtin.debug:
    var: create_group_subgroups

- name: Verify create_group_subgroups is changed
  ansible.builtin.assert:
    that:
      - create_group_subgroups is changed

- name: Create group with subgroups and owners (idempotent)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: group_with_subgroups
    users:
      - bruno
    subgroups:
      - super_admins
    owners:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_group_subgroups_idempotent

- name: Output create_group_subgroups_idempotent
  ansible.builtin.debug:
    var: create_group_subgroups_idempotent

- name: Verify create_group_subgroups_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_group_subgroups_idempotent is not changed

- name: Update group subgroups
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: group_with_subgroups
    users:
      - bruno
    subgroups: []
    owners:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: update_group_subgroups

- name: Output update_group_subgroups
  ansible.builtin.debug:
    var: update_group_subgroups

- name: Verify update_group_subgroups is changed
  ansible.builtin.assert:
    that:
      - update_group_subgroups is changed

- name: Update group subgroups (idempotent)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: group_with_subgroups
    users:
      - bruno
    subgroups: []
    owners:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: update_group_subgroups_idempotent

- name: Output update_group_subgroups_idempotent
  ansible.builtin.debug:
    var: update_group_subgroups_idempotent

- name: Verify update_group_subgroups_idempotent is not changed
  ansible.builtin.assert:
    that:
      - update_group_subgroups_idempotent is not changed

- name: Delete group with subgroups
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: group_with_subgroups
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_group_subgroups

- name: Verify delete_group_subgroups is changed
  ansible.builtin.assert:
    that:
      - delete_group_subgroups is changed

# Diff mode tests
- name: Create group with diff mode
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: diff_test_group
    users:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_create_group
  diff: true

- name: Output diff_create_group
  ansible.builtin.debug:
    var: diff_create_group

- name: Verify diff output on group create
  ansible.builtin.assert:
    that:
      - diff_create_group is changed
      - diff_create_group.diff is defined
      - diff_create_group.diff.before is defined
      - diff_create_group.diff.after is defined
      - diff_create_group.diff.before == ''
      - "'diff_test_group' in diff_create_group.diff.after"

- name: Create group with diff mode (idempotent)
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: diff_test_group
    users:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_create_group_idempotent
  diff: true

- name: Verify no diff on idempotent group run
  ansible.builtin.assert:
    that:
      - diff_create_group_idempotent is not changed
      - diff_create_group_idempotent.diff is not defined

- name: Update group with diff mode
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: diff_test_group
    timeout: 7200
    users:
      - bruno
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_update_group
  diff: true

- name: Output diff_update_group
  ansible.builtin.debug:
    var: diff_update_group

- name: Verify diff output on group update
  ansible.builtin.assert:
    that:
      - diff_update_group is changed
      - diff_update_group.diff is defined
      - "'Timeout: 43200' in diff_update_group.diff.before"
      - "'Timeout: 7200' in diff_update_group.diff.after"

- name: Delete group with diff mode
  ripclawffb.helix_core.helix_core_group:
    state: absent
    name: diff_test_group
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_delete_group
  diff: true

- name: Output diff_delete_group
  ansible.builtin.debug:
    var: diff_delete_group

- name: Verify diff output on group delete
  ansible.builtin.assert:
    that:
      - diff_delete_group is changed
      - diff_delete_group.diff is defined
      - "'diff_test_group' in diff_delete_group.diff.before"
      - diff_delete_group.diff.after == ''

- name: Fail when using invalid login
  ripclawffb.helix_core.helix_core_group:
    state: present
    name: new_group
    users:
      - bruno
    server: '1666'
    user: bruno1
    charset: auto
    password: ''
  register: create_group_invalid_login
  ignore_errors: true

- name: Output create_group_invalid_login
  ansible.builtin.debug:
    var: create_group_invalid_login

- name: Verify create_group_invalid_login failed
  ansible.builtin.assert:
    that:
      - create_group_invalid_login.failed | bool

- name: Fail when using invalid port
  ripclawffb.helix_core.helix_core_user:
    state: present
    name: new_group
    users:
      - bruno
    server: '1667'
    user: bruno
    charset: auto
    password: ''
  register: create_group_invalid_port
  ignore_errors: true

- name: Output create_group_invalid_port
  ansible.builtin.debug:
    var: create_group_invalid_port

- name: Verify create_group_invalid_port failed
  ansible.builtin.assert:
    that:
      - create_group_invalid_port.failed | bool
