# Test code for the Helix server module
# -*- coding: utf-8 -*-

# Copyright: (c) 2019, Asif Shaikh (@ripclawffb) <ripclaw_ffb@hotmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# - name: Install required lib
#   pip:
#     name: p4python
#     executable: pip3

- name: Create a new server spec
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: standard
    description: 'Created by root.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_server_spec

- name: Output create_server_spec
  ansible.builtin.debug:
    var: create_server_spec

- name: Verify create_server_spec is changed
  ansible.builtin.assert:
    that:
      - create_server_spec is changed

- name: Create new server spec (idempotent)
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: standard
    description: 'Created by root.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_server_idempotent

- name: Output create_server_idempotent
  ansible.builtin.debug:
    var: create_server_idempotent

- name: Verify create_server_idempotent is not changed
  ansible.builtin.assert:
    that:
      - create_server_idempotent is not changed

- name: Update server spec
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: standard
    description: 'Created by user.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: update_server

- name: Output update_server
  ansible.builtin.debug:
    var: update_server

- name: Verify update_server is changed
  ansible.builtin.assert:
    that:
      - update_server is changed

- name: Update server spec (idempotent)
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: standard
    description: 'Created by user.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: update_server_idempotent

- name: Output update_server_idempotent
  ansible.builtin.debug:
    var: update_server_idempotent

- name: Verify update_server_idempotent is not changed
  ansible.builtin.assert:
    that:
      - update_server_idempotent is not changed

- name: Delete a server spec
  ripclawffb.helix_core.helix_core_server:
    state: absent
    serverid: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_server_spec

- name: Output delete_server_spec
  ansible.builtin.debug:
    var: delete_server_spec

- name: Verify delete_server_spec is changed
  ansible.builtin.assert:
    that:
      - delete_server_spec is changed

- name: Delete a server (idempotent)
  ripclawffb.helix_core.helix_core_server:
    state: absent
    serverid: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_server_idempotent

- name: Output delete_server_idempotent
  ansible.builtin.debug:
    var: delete_server_idempotent

- name: Verify delete_server_idempotent is not changed
  ansible.builtin.assert:
    that:
      - delete_server_idempotent is not changed

- name: Create filtered edge server (check mode)
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: edge_replica
    description: 'Created by root.'
    archivedatafilter:
      - //depot1/...
      - -//depot2/...
    clientdatafilter:
      - -//workstation1/...
    revisiondatafilter:
      - //depot1/...
      - -//depot2/...
    services: edge-server
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_server_check_mode
  check_mode: true

- name: Output create_server_check_mode
  ansible.builtin.debug:
    var: create_server_check_mode

- name: Verify create_server_check_mode is changed
  ansible.builtin.assert:
    that:
      - create_server_check_mode is changed

- name: Create filtered edge server (confirm check mode)
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: edge_replica
    description: 'Created by root.'
    archivedatafilter:
      - //depot1/...
      - -//depot2/...
    clientdatafilter:
      - -//workstation1/...
    revisiondatafilter:
      - //depot1/...
      - -//depot2/...
    services: edge-server
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: create_server_check_mode_confirm

- name: Output create_server_check_mode_confirm
  ansible.builtin.debug:
    var: create_server_check_mode_confirm

- name: Verify create_server_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - create_server_check_mode_confirm is changed

- name: Update filtered edge server
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: edge_replica
    description: 'Created by root.'
    archivedatafilter:
      - //depot2/...
      - -//depot1/...
    clientdatafilter:
      - -//workstation1/...
    revisiondatafilter:
      - //depot1/...
      - -//depot2/...
    services: edge-server
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: update_edge_archivedata

- name: Output update_edge_archivedata
  ansible.builtin.debug:
    var: update_edge_archivedata

- name: Verify update_edge_archivedata is changed
  ansible.builtin.assert:
    that:
      - update_edge_archivedata is changed

- name: Delete filtered edge server (check mode)
  ripclawffb.helix_core.helix_core_server:
    state: absent
    serverid: edge_replica
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_server_check_mode
  check_mode: true

- name: Output delete_server_check_mode
  ansible.builtin.debug:
    var: delete_server_check_mode

- name: Verify delete_server_check_mode is changed
  ansible.builtin.assert:
    that:
      - delete_server_check_mode is changed

- name: Delete filtered edge server (confirm check mode)
  ripclawffb.helix_core.helix_core_server:
    state: absent
    serverid: edge_replica
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: delete_server_check_mode_confirm

- name: Output delete_server_check_mode_confirm
  ansible.builtin.debug:
    var: delete_server_check_mode_confirm

- name: Verify delete_server_check_mode_confirm is changed
  ansible.builtin.assert:
    that:
      - delete_server_check_mode_confirm is changed

# Diff mode tests
- name: Create server with diff mode
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: diff_test_server
    description: 'Diff test server.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_create_server
  diff: true

- name: Output diff_create_server
  ansible.builtin.debug:
    var: diff_create_server

- name: Verify diff output on server create
  ansible.builtin.assert:
    that:
      - diff_create_server is changed
      - diff_create_server.diff is defined
      - diff_create_server.diff.before is defined
      - diff_create_server.diff.after is defined
      - diff_create_server.diff.before == ''
      - "'Diff test server.' in diff_create_server.diff.after"

- name: Create server with diff mode (idempotent)
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: diff_test_server
    description: 'Diff test server.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_create_server_idempotent
  diff: true

- name: Verify no diff on idempotent server run
  ansible.builtin.assert:
    that:
      - diff_create_server_idempotent is not changed
      - diff_create_server_idempotent.diff is not defined

- name: Update server with diff mode
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: diff_test_server
    description: 'Diff test server updated.'
    services: standard
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_update_server
  diff: true

- name: Output diff_update_server
  ansible.builtin.debug:
    var: diff_update_server

- name: Verify diff output on server update
  ansible.builtin.assert:
    that:
      - diff_update_server is changed
      - diff_update_server.diff is defined
      - "'Diff test server.' in diff_update_server.diff.before"
      - "'Diff test server updated.' in diff_update_server.diff.after"

- name: Delete server with diff mode
  ripclawffb.helix_core.helix_core_server:
    state: absent
    serverid: diff_test_server
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_delete_server
  diff: true

- name: Output diff_delete_server
  ansible.builtin.debug:
    var: diff_delete_server

- name: Verify diff output on server delete
  ansible.builtin.assert:
    that:
      - diff_delete_server is changed
      - diff_delete_server.diff is defined
      - "'Diff test server' in diff_delete_server.diff.before"
      - diff_delete_server.diff.after == ''

- name: Fail when using invalid login
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: edge_replica2
    description: 'Created by root.'
    services: edge-server
    server: '1666'
    user: bruno1
    charset: auto
    password: ''
  register: create_server_invalid_login
  ignore_errors: true

- name: Output create_server_invalid_login
  ansible.builtin.debug:
    var: create_server_invalid_login

- name: Verify create_server_invalid_login failed
  ansible.builtin.assert:
    that:
      - create_server_invalid_login.failed | bool

- name: Fail when using invalid port
  ripclawffb.helix_core.helix_core_server:
    state: present
    serverid: edge_replica2
    description: 'Created by root.'
    services: edge-server
    server: '1667'
    user: bruno
    charset: auto
    password: ''
  register: create_server_invalid_port
  ignore_errors: true

- name: Output create_server_invalid_port
  ansible.builtin.debug:
    var: create_server_invalid_port

- name: Verify create_server_invalid_port failed
  ansible.builtin.assert:
    that:
      - create_server_invalid_port.failed | bool
