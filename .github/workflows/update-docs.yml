name: Update Documentation
on:
  push:
    branches:
      - master
    paths:
      - 'plugins/modules/*.py'
      - 'plugins/module_utils/*.py'
  workflow_dispatch:

env:
  COLLECTION_NAMESPACE: ripclawffb
  COLLECTION_NAME: helix_core

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python3 -m pip install pipenv
          pipenv install

      - name: Setup Ansible Collection Folder
        run: |
          mkdir -p ~/.ansible/collections/ansible_collections/$COLLECTION_NAMESPACE/$COLLECTION_NAME
          cp -r . ~/.ansible/collections/ansible_collections/$COLLECTION_NAMESPACE/$COLLECTION_NAME/

      - name: Lint collection documentation
        run: |
          pipenv run antsibull-docs lint-collection-docs --plugin-docs \
            ~/.ansible/collections/ansible_collections/$COLLECTION_NAMESPACE/$COLLECTION_NAME

      - name: Generate documentation
        run: |
          # Create temp directory for RST files
          rm -rf temp-rst
          mkdir -p temp-rst
          
          # Generate collection documentation with squash-hierarchy for cleaner output
          pipenv run antsibull-docs collection \
              --use-current \
              --squash-hierarchy \
              --no-use-html-blobs \
              --breadcrumbs \
              --indexes \
              --dest-dir temp-rst \
              $COLLECTION_NAMESPACE.$COLLECTION_NAME
          
          # Copy to RST source directory
          rsync -cprv --delete-after temp-rst/collections/ rst/collections/
          
          # Build Sphinx site
          pipenv run sphinx-build -M html rst build -c . -W --keep-going
          
          # Copy to docs folder for GitHub Pages
          rm -rf docs/*
          cp -r build/html/* docs/

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet docs/ || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: Update module documentation'
          title: 'docs: Update module documentation'
          body: |
            This PR was automatically generated to update the module documentation.
            
            The documentation was regenerated because module files were changed on master.
            
            Generated by the `update-docs` workflow.
          branch: update-docs-${{ github.sha }}
          base: master
          delete-branch: true
