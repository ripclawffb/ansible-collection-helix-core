# Test code for the Helix protect module
# -*- coding: utf-8 -*-

# Copyright: (c) 2024, Asif Shaikh (@ripclawffb) <ripclaw_ffb@hotmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# Test adding individual entries (entry mode)
- name: Add protection entry
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: read
        type: group
        name: test_readers
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: add_entry

- name: Get protections after add
  ripclawffb.helix_core.helix_core_protect_info:
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: protect_info_after_add

- name: Verify entry was added
  ansible.builtin.assert:
    that:
      - "'read' in (protect_info_after_add.protections | selectattr('name', 'equalto', 'test_readers') | map(attribute='access') | list)"

- name: Output add_entry
  ansible.builtin.debug:
    var: add_entry

- name: Verify add_entry is changed
  ansible.builtin.assert:
    that:
      - add_entry is changed

- name: Add protection entry (idempotent)
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: read
        type: group
        name: test_readers
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: add_entry_idempotent

- name: Output add_entry_idempotent
  ansible.builtin.debug:
    var: add_entry_idempotent

- name: Verify add_entry_idempotent is not changed
  ansible.builtin.assert:
    that:
      - add_entry_idempotent is not changed

# Test adding multiple entries
- name: Add multiple protection entries
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: write
        type: group
        name: test_writers
        host: "*"
        path: //depot/...
      - access: admin
        type: user
        name: test_admin
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: add_multiple

- name: Get protections after add multiple
  ripclawffb.helix_core.helix_core_protect_info:
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: protect_info_after_add_multiple

- name: Verify entries were added
  ansible.builtin.assert:
    that:
      - "'write' in (protect_info_after_add_multiple.protections | selectattr('name', 'equalto', 'test_writers') | map(attribute='access') | list)"
      - "'admin' in (protect_info_after_add_multiple.protections | selectattr('name', 'equalto', 'test_admin') | map(attribute='access') | list)"

- name: Output add_multiple
  ansible.builtin.debug:
    var: add_multiple

- name: Verify add_multiple is changed
  ansible.builtin.assert:
    that:
      - add_multiple is changed

- name: Add multiple protection entries (idempotent)
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: write
        type: group
        name: test_writers
        host: "*"
        path: //depot/...
      - access: admin
        type: user
        name: test_admin
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: add_multiple_idempotent

- name: Output add_multiple_idempotent
  ansible.builtin.debug:
    var: add_multiple_idempotent

- name: Verify add_multiple_idempotent is not changed
  ansible.builtin.assert:
    that:
      - add_multiple_idempotent is not changed

# Test removing individual entries
- name: Remove protection entry
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: read
        type: group
        name: test_readers
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: remove_entry

- name: Get protections after remove
  ripclawffb.helix_core.helix_core_protect_info:
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: protect_info_after_remove

- name: Verify entry was removed
  ansible.builtin.assert:
    that:
      - "(protect_info_after_remove.protections | selectattr('name', 'equalto', 'test_readers') | list | length) == 0"

- name: Output remove_entry
  ansible.builtin.debug:
    var: remove_entry

- name: Verify remove_entry is changed
  ansible.builtin.assert:
    that:
      - remove_entry is changed

- name: Remove protection entry (idempotent)
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: read
        type: group
        name: test_readers
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: remove_entry_idempotent

- name: Output remove_entry_idempotent
  ansible.builtin.debug:
    var: remove_entry_idempotent

- name: Verify remove_entry_idempotent is not changed
  ansible.builtin.assert:
    that:
      - remove_entry_idempotent is not changed

# Test removing multiple entries
- name: Remove multiple protection entries
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: write
        type: group
        name: test_writers
        host: "*"
        path: //depot/...
      - access: admin
        type: user
        name: test_admin
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: remove_multiple

- name: Get protections after remove multiple
  ripclawffb.helix_core.helix_core_protect_info:
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: protect_info_after_remove_multiple

- name: Verify entries were removed
  ansible.builtin.assert:
    that:
      - "(protect_info_after_remove_multiple.protections | selectattr('name', 'equalto', 'test_writers') | list | length) == 0"
      - "(protect_info_after_remove_multiple.protections | selectattr('name', 'equalto', 'test_admin') | list | length) == 0"

- name: Output remove_multiple
  ansible.builtin.debug:
    var: remove_multiple

- name: Verify remove_multiple is changed
  ansible.builtin.assert:
    that:
      - remove_multiple is changed

- name: Remove multiple protection entries (idempotent)
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: write
        type: group
        name: test_writers
        host: "*"
        path: //depot/...
      - access: admin
        type: user
        name: test_admin
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: remove_multiple_idempotent

- name: Output remove_multiple_idempotent
  ansible.builtin.debug:
    var: remove_multiple_idempotent

- name: Verify remove_multiple_idempotent is not changed
  ansible.builtin.assert:
    that:
      - remove_multiple_idempotent is not changed

# Test check mode
- name: Add entry (check mode)
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: super
        type: user
        name: check_mode_user
        host: "*"
        path: //...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: check_mode_add
  check_mode: true

- name: Output check_mode_add
  ansible.builtin.debug:
    var: check_mode_add

- name: Verify check_mode_add is changed
  ansible.builtin.assert:
    that:
      - check_mode_add is changed

- name: Verify entry was not actually added (check mode confirmation)
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: super
        type: user
        name: check_mode_user
        host: "*"
        path: //...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: check_mode_confirm

- name: Verify check_mode_confirm is changed (entry wasn't added)
  ansible.builtin.assert:
    that:
      - check_mode_confirm is changed

# Test security block - should fail
- name: Attempt to clear protection table (should fail)
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    mode: replace
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: clear_table
  ignore_errors: true

- name: Output clear_table
  ansible.builtin.debug:
    var: clear_table

- name: Verify clear_table failed with security message
  ansible.builtin.assert:
    that:
      - clear_table.failed | bool
      - "'not allowed' in clear_table.msg"

# Clean up test entries
- name: Remove test entries
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: write
        type: group
        name: test_writers
        host: "*"
        path: //depot/...
      - access: admin
        type: user
        name: test_admin
        host: "*"
        path: //depot/...
      - access: super
        type: user
        name: check_mode_user
        host: "*"
        path: //...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: cleanup

- name: Output cleanup
  ansible.builtin.debug:
    var: cleanup

# Diff mode tests
- name: Add protection entry with diff mode
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: list
        type: user
        name: diff_test_user
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_add_protect
  diff: true

- name: Output diff_add_protect
  ansible.builtin.debug:
    var: diff_add_protect

- name: Verify diff output on protect add
  ansible.builtin.assert:
    that:
      - diff_add_protect is changed
      - diff_add_protect.diff is defined
      - diff_add_protect.diff.before is defined
      - diff_add_protect.diff.after is defined
      - "'diff_test_user' in diff_add_protect.diff.after"

- name: Add protection entry with diff mode (idempotent)
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: list
        type: user
        name: diff_test_user
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_add_protect_idempotent
  diff: true

- name: Verify no diff on idempotent protect run
  ansible.builtin.assert:
    that:
      - diff_add_protect_idempotent is not changed
      - diff_add_protect_idempotent.diff is not defined

- name: Remove protection entry with diff mode
  ripclawffb.helix_core.helix_core_protect:
    state: absent
    protections:
      - access: list
        type: user
        name: diff_test_user
        host: "*"
        path: //depot/...
    server: '1666'
    user: bruno
    charset: auto
    password: ''
  register: diff_remove_protect
  diff: true

- name: Output diff_remove_protect
  ansible.builtin.debug:
    var: diff_remove_protect

- name: Verify diff output on protect remove
  ansible.builtin.assert:
    that:
      - diff_remove_protect is changed
      - diff_remove_protect.diff is defined
      - "'diff_test_user' in diff_remove_protect.diff.before"

# Test invalid login
- name: Fail when using invalid login
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: read
        type: user
        name: test
        host: "*"
        path: //...
    server: '1666'
    user: bruno1
    charset: auto
    password: ''
  register: protect_invalid_login
  ignore_errors: true

- name: Output protect_invalid_login
  ansible.builtin.debug:
    var: protect_invalid_login

- name: Verify protect_invalid_login failed
  ansible.builtin.assert:
    that:
      - protect_invalid_login.failed | bool

- name: Fail when using invalid port
  ripclawffb.helix_core.helix_core_protect:
    state: present
    protections:
      - access: read
        type: user
        name: test
        host: "*"
        path: //...
    server: '1667'
    user: bruno
    charset: auto
    password: ''
  register: protect_invalid_port
  ignore_errors: true

- name: Output protect_invalid_port
  ansible.builtin.debug:
    var: protect_invalid_port

- name: Verify protect_invalid_port failed
  ansible.builtin.assert:
    that:
      - protect_invalid_port.failed | bool
